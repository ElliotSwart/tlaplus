<?xml version="1.0" encoding="UTF-8"?>
<project name="TLA+ Tools" default="default" xmlns:jacoco="antlib:org.jacoco.ant">


	<!-- JaCoCo code coverage -->
	<taskdef uri="antlib:org.jacoco.ant" resource="org/jacoco/ant/antlib.xml">
		<classpath path="lib/jacocoant.jar"/>
	</taskdef>

	<taskdef resource="org/aspectj/tools/ant/taskdefs/aspectjTaskdefs.properties">
		<classpath>
			<pathelement location="lib/aspectjtools-1.9.2.jar" />
		</classpath>
	</taskdef>
	
	<!-- Similar to default except it skips test and only runs test-dist. This is called from pom.xml -->
	<target name="default-maven" depends="info" description="Default">
		<antcall target="compile" inheritall="true" inheritrefs="true" />
		<antcall target="compile-aj" inheritall="true" inheritrefs="true" />
		<antcall target="compile-test" inheritall="true" inheritrefs="true" />
		<!-- <antcall target="test" inheritall="true" inheritrefs="true" /> -->
		<antcall target="git-revision" inheritall="true" inheritrefs="true" />
		<antcall target="dist" inheritall="true" inheritrefs="true" />
		<antcall target="test-dist" inheritall="true" inheritrefs="true" />
	</target>


	<!-- Compiles and runs the short-running tests. -->
	<target name="shorttests" depends="info" description="Run tests">
		<antcall target="default" inheritall="true" inheritrefs="true" />
		<antcall target="test-verify" inheritall="true" inheritrefs="true" />
	</target>

	<!-- Compiles and runs *only* the long-running tests. Not the ones. -->
	<target name="longtests" depends="info" description="Run long-running tests">
		<antcall target="compile" inheritall="true" inheritrefs="true" />
		<antcall target="compile-aj" inheritall="true" inheritrefs="true">
			<!-- long tests require AspjectJ -->
	        <param name="withaj" value="true"/>
	    </antcall>
		<antcall target="compile-test" inheritall="true" inheritrefs="true" />
		<antcall target="dist" inheritall="true" inheritrefs="true" />
		<antcall target="test-dist-long" inheritall="true" inheritrefs="true" />
	</target>

	<!-- Compiles AspectJ auxiliary code -->
	<target name="compile-aj" if="withaj">
		<echo>
			====================================================================
			= The following warnings (Xlint:adviceDidNotMatch) can be ignored. =
			= We are doing load time weaving that kicks in when TLC gets       = 
			= started, not when it is compiled.                                =
			====================================================================
		</echo>
		<!-- compile aspectj related class files -->
		<iajc destdir="${class.dir}" debug="true" verbose="true" source="1.8" target="1.8">
			<sourceroots>
				<!-- Here we implicitly decide to use AspectJ Load-Time weaving by excludign ${src.dir} as a pathelement. Adding ${src.dir} results in aspects being woven at compile-time as part of the ant build. -->
				<pathelement location="${src-aj.dir}"/>
			</sourceroots>
			<classpath refid="project.classpath" />
			<classpath>
				<pathelement location="lib/aspectjrt-1.9.2.jar" />
				<pathelement location="lib/aspectjtools-1.9.2.jar" />
				<pathelement path="${class.dir}" />
			</classpath>
		</iajc>
		<!-- copy the resource files -->
		<copy todir="${class.dir}">
			<fileset dir="${src-aj.dir}">
				<include name="**/*.*" />
				<exclude name="**/*.aj" />
				<exclude name="**/*.java" />
				<exclude name="**/*.~*" />
				<exclude name="**/*##*" />
			</fileset>
		</copy>
		<!-- These files are requried for load time weaving and during runtime -->
		<copy todir="${class.dir}/lib">
			<fileset dir="lib/">
				<include name="aspectjrt-1.9.2.jar" />
				<include name="aspectjweaver-1.9.2.jar" />
			</fileset>
		</copy>
	</target>


	<!-- Executes accompanying unit tests on jar file -->
	<target name="test-dist" unless="test.skip">
		<!-- run junit tests on tlatools.jar -->
		<mkdir dir="${test.reports}/onJar" />
		<jacoco:coverage destfile="target/code-coverage.exec" includes="pcal.*:tla2sany.*:tla2tex.*:tlc2.*:util.*:org.lamport.*" excludes="com.sun.*:javax.*:**/Tests.*:**/*Test*">
			<junit printsummary="yes" haltonfailure="${test.halt}" haltonerror="${test.halt}" forkmode="perTest" fork="yes">
				<!-- enable all assertions -->
				<jvmarg value="-ea"/>
				<jvmarg value="-XX:MaxDirectMemorySize=512k"/>
				<jvmarg value="-XX:+UseParallelGC"/>
				<classpath refid="project.classpath" />
				<classpath>
					<pathelement location="lib/junit-4.12.jar" />
					<pathelement location="lib/hamcrest-core-1.3.jar" />
					<pathelement location="lib/cglib-nodep-3.1.jar" />
					<pathelement location="lib/objenesis-2.1.jar" />
					<pathelement location="lib/easymock-3.3.1.jar" />
					<pathelement location="lib/lsp/org.eclipse.lsp4j.debug-0.12.0.jar"/>
					<pathelement location="lib/lsp/org.eclipse.lsp4j.jsonrpc-0.12.0.jar"/>
					<pathelement location="lib/lsp/org.eclipse.lsp4j.jsonrpc.debug-0.12.0.jar"/>
					<pathelement location="${dist.file}" />
					<pathelement path="${test.class.dir}" />
					<pathelement path="test-model/" />
					<pathelement location="test-model/UserModuleOverrideFromJar.jar" />
				</classpath>
	
				<formatter type="xml" />
				<sysproperty key="basedir" value="${basedir}/"/>
				<sysproperty key="util.FileUtil.milliseconds" value="true"/>
				<sysproperty key="tlc2.tool.fp.FPSet.impl" value="tlc2.tool.fp.OffHeapDiskFPSet"/>
				<sysproperty key="tlc2.tool.distributed.TLCWorker.threadCount" value="4"/>
	
				<batchtest fork="yes" todir="${test.reports}/onJar">
					<fileset dir="${test.dir}">
						<include name="**/*Test*.java" />
						
						<!-- Produce bogus crash with Quarantine runner. -->
						<exclude name="tlc2/tool/distributed/TLCSetTest.java" />
						<exclude name="tlc2/tool/distributed/DistributedDoInitFunctorEvalExceptionTest.java" />
						<!-- Just fail because of Quarantine runner. -->
						<exclude name="tlc2/TLCTest.java"/>
						<exclude name="tlc2/tool/fp/OffHeapDiskFPSetTest.java"/>
						<exclude name="tlc2/tool/UserModuleOverrideTest.java" />
						<exclude name="tlc2/tool/UserModuleOverrideFromJarTest.java" />
						<exclude name="tlc2/tool/UserModuleOverrideAnnotationTest.java" />
												
						<exclude name="**/PCalTest.java" />
						<exclude name="**/SANYTest.java" />
						<exclude name="**/*_TTraceTest.java" />
						<exclude name="**/CommonTestCase.java" />
						<exclude name="**/ModelCheckerTestCase.java" />
						<exclude name="**/TTraceModelCheckerTestCase.java" />
						<exclude name="**/TLCDebuggerTestCase.java" />
						<exclude name="**/PCalModelCheckerTestCase.java" />
						<exclude name="**/TraceExpressionSpecTest.java" />
						<exclude name="**/TraceExpressionSpecSafetyTest.java" />
						<exclude name="**/SuiteTestCase.java" />
						<exclude name="**/SuiteETestCase.java" />
						<exclude name="**/DistributedTLCTestCase.java" />
						<exclude name="**/TLCServerTestCase.java" />
						<exclude name="**/SuccessfulSimulationTestCase.java" />
						<exclude name="**/AbstractExampleTestCase.java" />
						<exclude name="**/AbstractCoverageTest.java" />
						<exclude name="**/InitEvalOrderTest.java" />
						<exclude name="**/BidirectionalTransitions1BTest.java" />
						<exclude name="**/BidirectionalTransitions2CTest.java" />
						<exclude name="**/TestMPRecorder.java" />
						<exclude name="**/TestPrintStream.java" />
						<exclude name="**/Abstract*Test.java" />
						<exclude name="**/TestDriver.java" />
						<exclude name="**/TestDriver2.java" />
						<exclude name="**/AllTests.java" />
						<exclude name="util/IsolatedTestCaseRunner.java"/>
						<!-- Known test failures -->
						<exclude name="**/pcal/StackTestTest.java" />
						<exclude name="**/pcal/TestPCandStackTest.java" />
						<!-- These take too long -->
						<exclude name="**/MacroQuicksortTest.java" />
						<exclude name="**/MacroRealQuicksortTest.java" />
						<exclude name="**/PcalPaxosTest.java" />
						<exclude name="**/DetlefsTest.java" />
						<exclude name="**/StarkMutexTest.java" />
						<exclude name="**/SimpleMultiProcTest.java" />
						<!-- The test checks if Tool/FastTool methods are correctly inlined during (long) 
						     model-checking. It fails with this target but passes with test.  I assume
						     this is because test-dist records coverage, which, perhaps, interferes with inlining. -->
						<exclude name="**/InliningTest.java" />
					</fileset>
				</batchtest>
				<batchtest fork="yes" todir="${test.reports}">
					<fileset dir="${test.dir}">
						<!-- Run TTrace tests after the original tests are run -->	
						<include name="**/*_TTraceTest.java" />
					</fileset>
				</batchtest>
				<batchtest fork="yes" todir="${test.reports}">
					<fileset dir="${test.dir}">
						<include name="tlc2/tool/UserModuleOverrideAnnotationTest.java" />
					</fileset>
				</batchtest>
				<batchtest fork="yes" todir="${test.reports}">
					<fileset dir="${test.dir}">
						<include name="tlc2/tool/UserModuleOverrideFromJarTest.java" />
					</fileset>
				</batchtest>
				<batchtest fork="yes" todir="${test.reports}/onJar">
					<fileset dir="${test.dir}">
						<include name="tlc2/tool/UserModuleOverrideTest.java" />
					</fileset>
				</batchtest>
				<batchtest fork="yes" todir="${test.reports}/onJar">
					<fileset dir="${test.dir}">
						<include name="tlc2/tool/distributed/TLCSetTest.java" />
					</fileset>
				</batchtest>
				<batchtest fork="yes" todir="${test.reports}/onJar">
					<fileset dir="${test.dir}">
						<include name="tlc2/tool/distributed/DistributedDoInitFunctorEvalExceptionTest.java" />
					</fileset>
				</batchtest>
				<batchtest fork="yes" todir="${test.reports}/onJar">
					<fileset dir="${test.dir}">
						<include name="tlc2/TLCTest.java"/>
						<include name="tlc2/tool/fp/OffHeapDiskFPSetTest.java"/>
					</fileset>
				</batchtest>
			</junit>
		</jacoco:coverage>

		<!-- remove copied class.dir -->
		<delete dir="${ws.class.dir}" deleteonexit="true"/>
	</target>

	<!-- Executes accompanying long-running unit tests on jar file -->
	<target name="test-dist-long" unless="test.skip">
		<!-- compile unit tests -->
		<mkdir dir="${test.class.dir}" />
		<javac includeantruntime="false" srcdir="${test.dir}-long" destdir="${test.class.dir}" debug="true" verbose="false">
			<classpath refid="project.classpath" />
			<classpath>
				<pathelement location="lib/junit-4.12.jar" />
				<pathelement location="lib/hamcrest-core-1.3.jar" />
				<pathelement path="${class.dir}" />
			</classpath>
		</javac>
		<!-- copy class.dir to path with whitespace -->
		<!-- this is required by some tests to make sense -->
		<!-- even throw a "+" and whitespace into the mix -->
		<property name="ws.class.dir" value="TLA+ Tools" />
		<copy todir="${ws.class.dir}">
			<fileset dir="${class.dir}" />
		</copy>
		<!-- run junit tests on tlatools.jar -->
		<mkdir dir="${test.reports}/onJarLong" />
		<junit printsummary="yes" haltonfailure="no" haltonerror="no" maxmemory="4096m" forkmode="perTest" fork="yes">
			<!-- enable all assertions -->
			<jvmarg value="-ea"/>
			<jvmarg value="-javaagent:lib/aspectjweaver-1.9.2.jar" />
			<sysproperty key="org.aspectj.weaver.showWeaveInfo" value="false"/>
			<sysproperty key="aj.weaving.verbose" value="false"/>
			<classpath refid="project.classpath" />
			<classpath>
				<pathelement location="lib/junit-4.12.jar" />
				<pathelement location="lib/hamcrest-core-1.3.jar" />
				<pathelement location="${dist.file}" />
				<pathelement path="${test.class.dir}" />
				<!-- Need class.dir on path to find AspectJ related classes which don't get packaged into dist -->
				<pathelement path="${class.dir}" />
			</classpath>

			<formatter type="xml" />

			<batchtest fork="yes" todir="${test.reports}/onJarLong">
				<fileset dir="${test.dir}-long">
					<exclude name="**/MultiThreadedSpecTest.java"/>

					<!-- The following tests take way too long (hours). -->
					<!-- Reactivate when you start working on the fingerprint sets! -->
					<exclude name="**/DiskFPSetTest.java"/>
					<exclude name="**/FPSetTest.java"/>
					<exclude name="**/MSBDiskFPSetTest.java"/>
					<exclude name="**/OffHeapDiskFPSetTest.java"/>
					<exclude name="**/DiskStateQueueTest.java"/>

					<include name="**/*Test*.java" />
				</fileset>
			</batchtest>
		</junit>

		<!-- remove copied class.dir -->
		<delete dir="${ws.class.dir}" deleteonexit="true"/>
	</target>

	<!-- Verifies TLC parts with NASA's pathfinder model checker -->
	<target name="test-verify">
		<mkdir dir="${test.class.dir}"/>
		<!-- Compile our boilerplate code needed to verify TLC. E.g. the StateQueueVerify creates -->
		<!-- examplary produces & consumers and a dummy implementation of StateQueue. -->
		<javac includeantruntime="false" srcdir="${test.dir}-verify" destdir="${test.class.dir}" debug="true" verbose="false">
			<classpath refid="project.classpath" />
			<classpath>
				<pathelement path="${class.dir}" />
				<pathelement location="lib/jpf.jar" />
			</classpath>
		</javac>

		<mkdir dir="${test.reports}/verify" />
		<junit printsummary="yes" haltonfailure="no" haltonerror="no" maxmemory="4096m" forkmode="perTest" fork="yes" 
			dir="${basedir}/test-verify" >
			<classpath refid="project.classpath" />
			<classpath>
				<pathelement location="lib/junit-4.12.jar" />
				<pathelement location="lib/hamcrest-core-1.3.jar" />
				<pathelement location="lib/jpf.jar" />
				<pathelement location="lib/jpf-classes.jar" />
				<pathelement path="${class.dir}" />
				<pathelement path="${test.class.dir}" />
			</classpath>

			<formatter type="xml" />

			<batchtest fork="yes" todir="${test.reports}/verify">
				<fileset dir="${test.dir}-verify">
					<include name="**/*Test*.java" />
				</fileset>
			</batchtest>
		</junit>
	</target>
</project>
